# Classify Terms #
## Readme for Evaluation ##

### DO NOT EDIT THIS FILE DURING RESULT EVALUATION ###

## This is a higher level workflow to calculate all seeds for all three groups at once and takes care of all additional data processing
##  Does not allow to show the chi^2 plots. They can, however, be saved in the object with get_plots = T


#### Preparations & data read-in ####

# run this part once 
{
  library(tidyverse)
  library(data.table)
  library(vroom)
  library(scales)
  library(future)
  library(furrr)
}

source("utils_text_processing.R") # text processing utils

source("workflow_seed_terms.R") # full seed terms worfklow


plan(multisession, workers = 8) # set up future multisession for future_map functions
options(future.globals.maxSize = (50000*1024^2)) # 5 gb Max Size for Parallelization Processes

chi2_ministries <- 500 # set chi^2 threshold for ministries
max_results_ministries <- NULL # number of maximum results for each ministry (NULL to skip). chi2 threshold remains active!

chi2_committee_members <- 250 # set chi^2 threshold for within-committee members
max_results_committee_members <-  NULL # number of maximum results for each committee member (NULL to skip). chi2 threshold remains active!

chi2_committees <- 30 # set chi^2 threshold between committees
max_results_committees <-  NULL # number of maximum results for each committee (NULL to skip). chi2 threshold remains active!

max_result_ties <-  FALSE # should ties for max results be kept? If TRUE, may return more than the requested number of seed terms

active_committees_only <- TRUE # should only committee tweets sent during their active period be used in the seed term generation?

date <- ymd("2023-04-25") # set date of the time frame you wish to calculate seeds for (max date)
time_frame_seeds <- years(1) # length of the time frame for seed term extraction (date - time_frame)

# set filtering options for seed terms and walk terms --- this may be slightly different than in the initial evaluation
seed_replies <- TRUE
seed_mentions <- FALSE
seed_urls <- TRUE

save_seeds <- FALSE # Do not save the output



# Read lists
ministries <- read_csv("Seed_Accounts/ministry_seeds_2023-04-06.csv", col_types = list(user_id = "c"))
committees <- read_csv("Seed_Accounts/committee_seeds_19-20_2023-04-06.csv", col_types = list(user_id = "c"))


# Get Tokenized Data
tokens <- get_latest_tokens_file(path = "Tokenizer", 
                                 pattern = "tokens_full.csv.tar.gz") %>% 
  vroom(col_types = list(doc_id = "c", `_source.author_id` = "c")) 


#### Extract Seed Terms ####

# this is the function claculating seeds and taking care of all processing 
#   only this needs to be re-run if any of the variables are changed

seed_terms <- seed_terms_workflow(    # high-level function for the whole seed term extraction workflow
  tokens = tokens,          # tokens object. Expects tokenized data returned by the tokenizer workflow
  ministries = ministries,      # ministry account list
  committees = committees,      # committee account list
  dir = NULL,             # subdirectory to save results in. NULL to skip
  date = date, # date for filtering purposes (max date)
  time_frame_seeds = time_frame_seeds, # length of the time frame for seed term extraction
  seed_replies = seed_replies, # should replies be utilized?
  seed_mentions = seed_mentions, # should mentions be utilizued?
  seed_urls = seed_urls, # should URLs be utilized?
  chi2_ministries = chi2_ministries, # set chi^2 threshold for ministries
  max_results_ministries = max_results_ministries,
  chi2_committee_members = chi2_committee_members, # set chi^2 threshold for within-committee members
  max_results_committee_members = max_results_committee_members,
  chi2_committees = chi2_committees, # set chi^2 threshold between committees
  max_results_committees = max_results_committees,
  max_result_ties = max_result_ties,
  active_committees_only = active_committees_only,
  save_seeds = save_seeds, # should the Seed Terms be saved explicitly in 'dir'? If TRUE, saves data for ministries, committees, and committee members seperately)
  get_plots = F, # should the plots be returned in the R object?
  verbose = T # verbosity. Should there be console output keeping track of the progress?
)


##### inspect seeds

# all seeds are saved within one object and can be accessed from there

seed_terms$seed_terms_ministries %>% View()

seed_terms$seed_terms_committees %>% View()

seed_terms$seed_terms_committee_members %>% View()


# if plots are returned (get_plots = T), you can access them and the data one layer deeper than before

## Terms
seed_terms$seed_terms_ministries$key_terms %>% View()

seed_terms$seed_terms_committees$key_terms %>% View()

seed_terms$seed_terms_committee_members$key_terms %>% View()

## Plots

seed_terms$seed_terms_ministries$plots$BMBF # replace seed term group and committe/ministry here as needed

seed_terms$seed_terms_committee_members$plots$`Arbeit und Soziales`$`Andreas Audretsch` # for committee members there is one extra layer naming the committee